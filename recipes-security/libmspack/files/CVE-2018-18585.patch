From f73679c1df7f17a05224b211b919e5659c0af400 Mon Sep 17 00:00:00 2001
From: Stuart Caie <kyzer@cabextract.org.uk>
Date: Wed, 17 Oct 2018 11:29:03 +0100
Subject: [PATCH 3/4] Avoid returning CHM file entries that are "blank" because
 they have embedded null bytes

CVE: CVE-2018-18585
Upstream-Status: Backport
Signed-off-by: Sam Kappen <skappen@mvista.com>
---
 ChangeLog     | 6 ++++++
 mspack/chmd.c | 6 +++---
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 251e1c4..e612170 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+2018-10-17  Stuart Caie <kyzer@cabextract.org.uk>
+
+	* chmd_read_headers(): again reject files with blank filenames, this
+	time because their 1st or 2nd byte is null, not because their length
+	is zero.  Thanks again to Hanno Böck for finding the issue.
+
 2018-04-26  Stuart Caie <kyzer@cabextract.org.uk>
 
 	* read_chunk(): the test that chunk numbers are in bounds was off
diff --git a/mspack/chmd.c b/mspack/chmd.c
index cea9fc2..beaccb7 100644
--- a/mspack/chmd.c
+++ b/mspack/chmd.c
@@ -447,14 +447,14 @@ static int chmd_read_headers(struct mspack_system *sys, struct mspack_file *fh,
     while (num_entries--) {
       READ_ENCINT(name_len);
       if (name_len > (unsigned int) (end - p)) goto chunk_end;
-      /* consider blank filenames to be an error */
-      if (name_len == 0) goto chunk_end;
       name = p; p += name_len;
-
       READ_ENCINT(section);
       READ_ENCINT(offset);
       READ_ENCINT(length);
 
+      /* ignore blank or one-char (e.g. "/") filenames we'd return as blank */
+      if (name_len < 2 || !name[0] || !name[1]) continue;
+
       /* empty files and directory names are stored as a file entry at
        * offset 0 with length 0. We want to keep empty files, but not
        * directory names, which end with a "/" */
-- 
2.7.4

