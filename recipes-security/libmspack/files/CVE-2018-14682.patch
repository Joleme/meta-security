From 3fd7b86144fa0f37e43e620a2dc978a61a6af25b Mon Sep 17 00:00:00 2001
From: Stuart Caie <kyzer@cabextract.org.uk>
Date: Tue, 6 Feb 2018 23:17:30 +0000
Subject: [PATCH 1/4] Fix off-by-one error in chmd TOLOWER() fallback

CVE: CVE-2018-14682
Upstream-Status: Backport
Signed-off-by: Sam Kappen <skappen@mvista.com>
---
 ChangeLog     | 5 +++++
 mspack/chmd.c | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/ChangeLog b/ChangeLog
index 63d88b5..dd48815 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+2018-02-06  Stuart Caie <kyzer@cabextract.org.uk>
+
+       * chmd.c: fixed an off-by-one error in the TOLOWER() macro, reported
+       by Dmitry Glavatskikh. Thanks Dmitry!
+
 2015-01-18  Stuart Caie <kyzer@4u.net>
 
 	* lzxd_decompress(): the byte-alignment code for reading uncompressed
diff --git a/mspack/chmd.c b/mspack/chmd.c
index 5a6ef54..387fd37 100644
--- a/mspack/chmd.c
+++ b/mspack/chmd.c
@@ -831,7 +831,7 @@ static int search_chunk(struct mschmd_header *chm,
 # endif
 # define TOLOWER(x) tolower(x)
 #else
-# define TOLOWER(x) (((x)<0||(x)>256)?(x):mspack_tolower_map[(x)])
+# define TOLOWER(x) (((x)<0||(x)>255)?(x):mspack_tolower_map[(x)])
 /* Map of char -> lowercase char for the first 256 chars. Generated with:
  * LC_CTYPE=en_GB.utf-8 perl -Mlocale -le 'print map{ord(lc chr).","} 0..255'
  */
-- 
2.7.4

